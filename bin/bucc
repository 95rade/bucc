#!/bin/bash
version="0.1"
description="BUCC (BOSH UAA Credhud Concourse) CLI"

repo_root=$(dirname "$0" | rev | cut -c5- | rev)
state=${repo_root}/state
mkdir -p $state

manifest="${repo_root}/src/bosh-deployment/bosh.yml"
vars_file_arg="--vars-file ${repo_root}/vars.yml"
ssh_private_key="${state}/ssh.key"
state_arg="--state ${state}/state.json"
ops_file_args=$(find ${repo_root}/ops/*.yml | sort | sed 's/^/-o /' | xargs)
vars_store=${state}/creds.yml
vars_store_arg="--vars-store ${vars_store}"

int_args="${manifest} ${ops_file_args} ${vars_store_arg} ${vars_file_arg}"

usage() {
    echo "Usage: bucc [up, down, ssh]" 1>&2; exit 1;
}

up() {
    bosh create-env $int_args $state_arg
}

down() {
    bosh delete-env $int_args $state_arg
}

env() {
    echo "export BOSH_ENVIRONMENT=$(ip)"
    echo "export BOSH_CA_CERT='$(store_int --path /director_ssl/ca)'"
    echo "export BOSH_CLIENT=admin"
    echo "export BOSH_CLIENT_SECRET=$(int --path /instance_groups/0/jobs/name=uaa/properties/uaa/scim/users/name=admin/password)"
}

store_int() {
    bosh int $vars_store $@
}

int() {
    bosh int $int_args $@
}

ip() {
    int --path /networks/name=default/subnets/0/static/0
}

_ssh() {
    local user=$(int --path /instance_groups/name=bosh/jobs/name=user_add/properties/users/0/name)
    store_int --path /jumpbox_ssh/private_key > $ssh_private_key
    chmod 600 $ssh_private_key
    ssh -i $ssh_private_key $user@$(ip) -t 'command; sudo su -'
}


default() {
    local optind
    while getopts ":v" opt; do
	case "${opt}" in
	    v)
		echo -e "${DESCRIPTION}, Version v${VERSION}"
		;;
	esac
    done
    shift $((optind-1))
    usage
}


case "$1" in
    up)
	up "$@"
	;;

    down)
	down "$@"
	;;

    env)
	env "$@"
	;;

    ssh)
	_ssh "$@"
	;;

    int)
	shift
	int "$@"
	;;
	

    *)
	default "$@"
	exit 1
	;;
esac
